<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Prevent iOS from zooming on text fields -->
  <meta name="viewport" 
        content="width=device-width, 
                 initial-scale=1.0, 
                 maximum-scale=1.0, 
                 user-scalable=no">
  <title>MSN-Style Chat</title>

  <style>
    /* 
      We'll rely on two theme classes on <body>: .light-theme or .dark-theme.
      Each sets CSS variables for color, background, etc.
    */

    :root {
      --transition-speed: 0.2s ease;
      --border-radius: 8px;

      /* Light theme defaults */
      --body-bg: linear-gradient(135deg, #d4dde5, #f8f9fc);
      --header-bg: linear-gradient(135deg, #c8dbf8, #d4dde5);
      --footer-bg: linear-gradient(135deg, #c8dbf8, #d4dde5);
      --chat-bg: #ffffff;
      --david-bubble-bg: #d6e9ff;
      --jacko-bubble-bg: #c8ffc9;
      --text-color: #000;
      --button-bg: linear-gradient(135deg, #f3f3f3, #d9d9d9);
      --button-hover-bg: linear-gradient(135deg, #e8e8e8, #c0c0c0);
      --avatar-bg: linear-gradient(135deg, #ffffff, #ebebeb);
    }

    .dark-theme {
      /* Dark theme overrides */
      --body-bg: linear-gradient(135deg, #4e4e4e, #2f2f2f);
      --header-bg: linear-gradient(135deg, #5a5a5a, #3c3c3c);
      --footer-bg: linear-gradient(135deg, #5a5a5a, #3c3c3c);
      --chat-bg: #444444;
      --david-bubble-bg: #617e9d;
      --jacko-bubble-bg: #5b995c;
      --text-color: #f1f1f1;
      --button-bg: linear-gradient(135deg, #777, #666);
      --button-hover-bg: linear-gradient(135deg, #666, #555);
      --avatar-bg: linear-gradient(135deg, #555, #333);
    }

    /* Global resets & transitions */
    * {
      margin: 0; padding: 0;
      box-sizing: border-box;
      font-family: Tahoma, Arial, sans-serif;
    }

    body {
      width: 100vw;
      height: 100vh;
      overflow: hidden; /* We handle scrolling in the .chat area only */
      background: var(--body-bg);
      color: var(--text-color);
      transition: background var(--transition-speed);
    }
    
    /* Container for entire messenger */
    .messenger {
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
      max-width: 700px;
      margin: 0 auto;
      border: 1px solid #666;
      border-radius: var(--border-radius);
      overflow: hidden;
      background: transparent; /* Let body background show behind it */
      position: relative;
    }

    /* HEADER */
    .header {
      display: flex;
      align-items: center;
      background: var(--header-bg);
      transition: background var(--transition-speed);
      min-height: 50px;
      border-bottom: 1px solid #666;
      padding: 0 8px;
    }
    .brand-logo {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
      border-radius: var(--border-radius);
      border: 1px solid #666;
      background: var(--avatar-bg);
      font-size: 24px;
      flex-shrink: 0;
    }
    .david-profile {
      display: flex;
      align-items: center;
      background: #ffffff33; /* slight alpha if you like */
      border: 1px solid #666;
      border-radius: var(--border-radius);
      padding: 0 5px;
      gap: 5px;
      flex-shrink: 1;
    }
    .david-avatar {
      width: 28px;
      height: 28px;
      border-radius: var(--border-radius);
      border: 1px solid #666;
      background: var(--avatar-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    .david-name {
      font-size: 14px;
      font-weight: bold;
      color: var(--text-color);
    }
    .david-status {
      display: inline-block;
      width: 45px;
      font-size: 11px;
      text-align: center;
      color: var(--text-color);
    }

    /* Header buttons */
    .header-buttons {
      margin-left: auto;
      display: flex;
      gap: 6px;
    }
    .header-buttons button {
      background: var(--button-bg);
      border: 1px solid #666;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 12px;
      padding: 4px 8px;
      color: #000;
      transition: background var(--transition-speed), color var(--transition-speed);
    }
    .header-buttons button:hover {
      background: var(--button-hover-bg);
      color: #000;
    }
    .header-buttons button:active {
      transform: scale(0.97);
    }

    /* CHAT AREA */
    .chat {
      flex: 1;
      background: var(--chat-bg);
      transition: background var(--transition-speed);
      overflow-y: auto; 
      overflow-x: hidden;
      padding: 8px;
    }

    /* MESSAGES */
    .message-block {
      display: flex;
      align-items: flex-start;
      margin-bottom: 8px;
      max-width: 80%;
      gap: 4px;
    }
    .message-block.jacko {
      align-self: flex-end;
      justify-content: flex-end;
    }
    .message-block.david {
      align-self: flex-start;
      justify-content: flex-start;
    }

    /* Each avatar next to the bubble */
    .bubble-avatar {
      width: 24px;
      height: 24px;
      border-radius: var(--border-radius);
      background: var(--avatar-bg);
      border: 1px solid #666;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .bubble {
      border: 1px solid #666;
      border-radius: var(--border-radius);
      padding: 6px 8px;
      color: var(--text-color);
      line-height: 1.4;
      background: #fff;
      transition: background var(--transition-speed);
    }
    .message-block.david .bubble {
      background: var(--david-bubble-bg);
    }
    .message-block.jacko .bubble {
      background: var(--jacko-bubble-bg);
    }

    /* Username on top of each bubble, smaller text */
    .bubble-username {
      font-weight: bold;
      font-size: 12px;
      margin-bottom: 2px;
    }

    /* FOOTER */
    .footer {
      background: var(--footer-bg);
      border-top: 1px solid #666;
      display: flex;
      align-items: center;
      padding: 5px;
      transition: background var(--transition-speed);
    }
    .footer .user-avatar {
      width: 36px;
      height: 36px;
      border: 1px solid #666;
      border-radius: var(--border-radius);
      background: var(--avatar-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin-right: 5px;
      flex-shrink: 0;
      color: #000;
    }
    .input-container {
      flex: 1;
      display: flex;
      border: 1px solid #666;
      border-radius: var(--border-radius);
      overflow: hidden; /* So that the input and button are contained nicely */
      background: #fff;
    }
    .input-container input {
      flex: 1;
      border: none;
      padding: 6px;
      font-size: 14px;
      outline: none;
      color: #000;
    }
    .send-btn {
      background: var(--button-bg);
      border: 1px solid #666;
      border-radius: 0; /* match container radius on one side */
      cursor: pointer;
      font-size: 14px;
      padding: 0 12px;
      transition: background var(--transition-speed), color var(--transition-speed);
    }
    .send-btn:hover {
      background: var(--button-hover-bg);
      color: #000;
    }
    .send-btn:active {
      transform: scale(0.98);
    }

    /* Nudge animation */
    @keyframes shake {
      0%   { transform: translate(0,0); }
      20%  { transform: translate(-3px,0); }
      40%  { transform: translate(3px,0); }
      60%  { transform: translate(-3px,0); }
      80%  { transform: translate(3px,0); }
      100% { transform: translate(0,0); }
    }
    .nudge {
      animation: shake 0.4s;
    }

    /* Typing indicator */
    .typing-indicator {
      align-self: flex-start;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
      max-width: 80%;
    }
    .typing-indicator .bubble {
      font-style: italic;
    }

    /* Scrollbar styling (optional) */
    .chat::-webkit-scrollbar {
      width: 8px;
    }
    .chat::-webkit-scrollbar-thumb {
      background: #aaa;
      border-radius: 4px;
    }

    /* Responsive considerations */
    @media (max-width: 700px) {
      .messenger {
        border-radius: 0; /* so it fits the screen edges better */
        max-width: 100%;
      }
    }
  </style>
</head>
<body class="light-theme">

<div class="messenger" id="messenger">
  
  <!-- HEADER -->
  <div class="header">
    <div class="brand-logo">‚≠ê</div>
    <div class="david-profile">
      <div class="david-avatar">üë§</div>
      <div class="david-name">David K</div>
      <div class="david-status" id="status">Online</div>
    </div>
    <div class="header-buttons">
      <button id="nudgeBtn">Nudge</button>
      <button id="themeBtn">Theme</button>
    </div>
  </div>

  <!-- CHAT AREA -->
  <div class="chat" id="chat"></div>

  <!-- FOOTER -->
  <div class="footer">
    <div class="user-avatar">ü§ñ</div>
    <div class="input-container">
      <input type="text" 
             id="messageInput" 
             placeholder="Type a message..." 
             onkeydown="handleKeyDown(event)"
             autocomplete="off" />
      <button class="send-btn" onclick="sendMessage()">Send</button>
    </div>
  </div>
</div>

<!-- Optional nudge sound -->
<audio id="nudgeSound" src="nudge.mp3" preload="auto"></audio>

<script>
// Keep track of theme (light vs dark)
let isDark = false;

// We‚Äôll fetch responses from JSON:
let responses = {
  nudgeResponses: [],
  greetingResponses: [],
  farewellResponses: [],
  questionResponses: [],
  generalResponses: []
};

// On load, fetch the JSON
fetch('responses.json')
  .then(res => res.json())
  .then(data => {
    responses = data;
  })
  .catch(err => {
    console.error("Error fetching responses.json:", err);
  });

// Elements
const messenger = document.getElementById('messenger');
const chatEl     = document.getElementById('chat');
const messageInput = document.getElementById('messageInput');
const statusEl   = document.getElementById("status");

// Theme toggle
document.getElementById('themeBtn').addEventListener('click', toggleTheme);
function toggleTheme() {
  isDark = !isDark;
  document.body.classList.toggle('dark-theme', isDark);
  document.body.classList.toggle('light-theme', !isDark);
}

// Nudge
document.getElementById('nudgeBtn').addEventListener('click', nudge);
function nudge() {
  // Visual nudge
  messenger.classList.add('nudge');
  setTimeout(() => messenger.classList.remove('nudge'), 400);

  // Optional nudge sound
  const nudgeSound = document.getElementById('nudgeSound');
  if (nudgeSound) nudgeSound.play();

  // Show user‚Äôs nudge in chat
  addMessage('Jacko', '*Nudge*', 'jacko');

  // David response
  showTypingIndicator();
  setTimeout(()=>{
    hideTypingIndicator();
    const nudgeReply = getDavidResponse('', true);
    addMessage('David K', nudgeReply, 'david');
    autoScroll();
  }, 1500);
}

// Rotation of statuses
const statusOptions = ["Online","Away","Busy"];
function updateStatus(){
  const prev = statusEl.innerText;
  let newStatus = prev;
  while(newStatus === prev){
    newStatus = statusOptions[Math.floor(Math.random()*statusOptions.length)];
  }
  statusEl.innerText = newStatus;
}
setInterval(updateStatus, 30000);

// Handling messages
function sendMessage(){
  const msg = messageInput.value.trim();
  if(!msg) return;
  
  addMessage('Jacko', msg, 'jacko');
  messageInput.value = '';
  messageInput.focus();
  autoScroll();

  showTypingIndicator();
  setTimeout(()=>{
    hideTypingIndicator();
    const reply = getDavidResponse(msg);
    addMessage('David K', reply, 'david');
    autoScroll();
  }, 1500);
}

function addMessage(username, text, userClass){
  const msgBlock = document.createElement('div');
  msgBlock.classList.add('message-block', userClass);

  // Avatar
  const avatar = document.createElement('div');
  avatar.classList.add('bubble-avatar');
  // Just pick an emoji for each user:
  avatar.textContent = (userClass === 'jacko') ? 'ü§ñ' : 'üë§';

  // Bubble
  const bubble = document.createElement('div');
  bubble.classList.add('bubble');

  // Username
  const nameEl = document.createElement('div');
  nameEl.classList.add('bubble-username');
  nameEl.innerText = username;

  // Actual message text
  const contentEl = document.createElement('div');
  contentEl.innerText = text;

  bubble.appendChild(nameEl);
  bubble.appendChild(contentEl);

  // If it‚Äôs David, avatar goes on the left; for Jacko, on the right
  if(userClass === 'david'){
    msgBlock.appendChild(avatar);
    msgBlock.appendChild(bubble);
  } else {
    msgBlock.appendChild(bubble);
    msgBlock.appendChild(avatar);
  }
  
  chatEl.appendChild(msgBlock);
}

// Typing Indicator
let typingEl = null;
function showTypingIndicator() {
  typingEl = document.createElement('div');
  typingEl.classList.add('typing-indicator', 'david');

  // Av + bubble
  const avatar = document.createElement('div');
  avatar.classList.add('bubble-avatar');
  avatar.textContent = 'üë§';

  const bubble = document.createElement('div');
  bubble.classList.add('bubble');
  bubble.innerText = "David is typing...";

  typingEl.appendChild(avatar);
  typingEl.appendChild(bubble);

  chatEl.appendChild(typingEl);
  autoScroll();
}
function hideTypingIndicator() {
  if(typingEl && chatEl.contains(typingEl)){
    chatEl.removeChild(typingEl);
    typingEl = null;
  }
}

// Chat logic for David
function getDavidResponse(userMsg, isNudge=false){
  if(isNudge) {
    return pickRandom(responses.nudgeResponses);
  }
  const lower = userMsg.toLowerCase();
  // Check farewell
  if(
    lower.includes("bye") || 
    lower.includes("cya") || 
    lower.includes("later") ||
    lower.includes("goodbye")
  ) {
    return pickRandom(responses.farewellResponses);
  }
  // Greeting
  if(
    lower.startsWith("hi") || 
    lower.startsWith("hello") || 
    lower.startsWith("hey")
  ){
    return pickRandom(responses.greetingResponses);
  }
  // Question
  if(lower.endsWith("?")) {
    return pickRandom(responses.questionResponses);
  }
  // Default
  return pickRandom(responses.generalResponses);
}

// Helper to pick a random line
function pickRandom(arr) {
  if(!arr || !arr.length) {
    return "Hmm... I have no words right now.";
  }
  return arr[Math.floor(Math.random()*arr.length)];
}

// Keydown handler (send on Enter)
function handleKeyDown(e){
  if(e.key === "Enter"){
    e.preventDefault();
    sendMessage();
  }
}

/* 
  Ensure chat stays pinned to bottom upon new messages
  Also handle iOS Safari‚Äôs keyboard shifting:
  - We'll run autoScroll after each message or typing indicator
*/
function autoScroll(){
  setTimeout(() => {
    chatEl.scrollTop = chatEl.scrollHeight;
  }, 50);
}
</script>
</body>
</html>